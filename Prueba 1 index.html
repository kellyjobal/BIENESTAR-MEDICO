<!DOCTYPE html>

<html>

<head>

  <base target="_top">

  <meta charset="utf-8" />

  <title>Dashboard Documentos y P√≥lizas</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

  <style>

    /* PALETA DE COLORES: Azul Principal #00A3D9, Verde/Lima #BED600 */

    *{margin:0;padding:0;box-sizing:border-box}

    body{font-family:'Segoe UI',Tahoma,Verdana,sans-serif;background:#FAFBFC;height:100vh;overflow:hidden;}

    .app-container{display:flex;height:100vh}

    

    /* SIDEBAR */

    .sidebar{width:250px;background:#00A3D9;color:#fff;flex-shrink:0;overflow-y:auto;box-shadow:2px 0 10px rgba(0,0,0,.1);}

    .sidebar-header-1{padding:20px;background:#FFFFFF}

    .sidebar-header{padding:20px;background:#BED600;}

    .sidebar-header h1{font-size:1.1rem;text-align:center;color:#00A3D9}

    

    .nav-menu{list-style:none;padding:20px 0}

    .nav-item{margin:5px 15px}

    .nav-link{display:flex;align-items:center;padding:12px 15px;color:rgba(255,255,255,1);text-decoration:none;border-radius:8px;cursor:pointer;}

    .nav-link.active{background:#007BA3;}

    

    /* CONTENIDO PRINCIPAL */

    .main-content{flex:1;overflow-y:auto;background:#FAFBFC}

    .content-header{background:#fff;padding:20px 30px;border-bottom:1px solid #e9ecef}

    .content-header h2{color:#2E86AB;}

    /* Grid de contenido cambiado a bloque para control manual del filtro */

    .content-body{padding:30px; } 

    

    /* CARDS Y M√âTRICAS */

    .card{background:#fff;border-radius:12px;padding:0;margin-bottom:20px;border:1px solid #E5F2F7;box-shadow:0 4px 6px rgba(0,0,0,.06);}

    .card-header{padding:16px 20px;background:#E5F2F7;border-bottom:1px solid #E5F2F7;color:#2E86AB;font-weight:600;}

    .card-body{padding:18px 20px}



    .metric-grid {display: grid;grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));gap: 20px;margin-bottom: 20px;text-align: center;}

    .metric-card {background: #E5F2F7;padding: 20px;border-radius: 10px;box-shadow: 0 2px 4px rgba(0,0,0,.05);border-left: 5px solid #00A3D9;}

    .metric-card h3 {font-size: 2.5rem;color: #00A3D9;margin-bottom: 5px;}

    .metric-card p {color: #2E86AB;font-weight: 600;text-transform: uppercase;font-size: 0.85rem;}



    .chart-grid {display: grid;grid-template-columns: 1fr 1fr;gap: 20px;}



    /* TABLA */

    .contenedor-tabla{width:100%;overflow-x:auto;margin-top:12px;border-radius:8px;max-height: 550px;overflow-y: auto;}

    .tabla{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.05)}

    .tabla thead tr{background:#00A3D9;color:#fff;font-weight:700}

    .tabla th,.tabla td{padding:12px 15px;border-bottom:1px solid #E5F2F7}

    .tabla tbody tr:hover {background-color: #F8FCFD;}

    .tabla thead th {position: sticky;top: 0;background: #00A3D9;color: white;z-index: 2;}

    

    .tab-content{display:none;}

    .tab-content.active{display:block;}



    .loading-message {text-align: center;padding: 20px;color: #00A3D9;font-size: 1.1rem;}

  </style>

</head>

<body>

  <div class="app-container">

    

    <nav class="sidebar">

      <div class="sidebar-header-1">

        <img src="https://www.clinicaportoazul.com/wp-content/uploads/2020/12/logo-cpa-auna2.png" 

            alt="Logo Clinica Portoazul AUNA" 

            style="width: 150px; display:block; margin: 0 auto 10px auto;">

      </div>



      <div class="sidebar-header">

        <h1>CONTROL DE CUMPLIMIENTO</h1>

      </div>

      

      <ul class="nav-menu">

        <li class="nav-item"><a class="nav-link active" onclick="showTab('documentos', event)">üìÑ Documentos</a></li>

        <li class="nav-item"><a class="nav-link" onclick="showTab('polizas', event)">üìã P√≥lizas</a></li>

      </ul>

    </nav>



    <div class="main-content">

      <div class="content-header"><h2 id="titulo-seccion">Control de Documentos M√©dicos</h2></div>



      <div id="documentos" class="tab-content active">

        <div class="content-body">

          

          <div style="margin-bottom:20px; max-width: 350px;">

            <label for="filtroEspecialidadDocumentos" style="font-weight: 600; color: #2E86AB; display: block; margin-bottom: 5px;">Filtrar por Especialidad:</label>

            <select 

              id="filtroEspecialidadDocumentos" 

              onchange="aplicarFiltroCompleto()"

              style="width: 100%; padding: 10px; border: 2px solid #E5F2F7; border-radius: 8px;"

            >

              <option value="TODAS">-- Cargando especialidades... --</option> 

            </select>

          </div>

          <div class="metric-grid">

            <div class="metric-card">

              <h3 id="total-medicos">0</h3>

              <p>Total de M√©dicos</p>

            </div>

            <div class="metric-card">

              <h3 id="promedio-general">0%</h3>

              <p>Promedio General de Cumplimiento</p>

            </div>

          </div>

          

          <div class="chart-grid">

            <div class="card">

              <div class="card-header">Cumplimiento Promedio por Especialidad</div>

              <div class="card-body">

                <canvas id="cumplimientoChart"></canvas>

              </div>

            </div>

            

            <div class="card" style="grid-column: span 2;">

              <div class="card-header">Detalle de Cumplimiento por M√©dico</div>

              <div class="card-body">

                <div class="contenedor-tabla">

                  <table id="tabla-detalle" class="tabla" role="table" aria-label="Detalle de cumplimiento">

                    <thead>

                      <tr>

                        <th>Especialidad</th>

                        <th>Nombre</th>

                        <th>C√©dula</th>

                        <th>Cumplimiento</th>

                      </tr>

                    </thead>

                    <tbody id="cuerpoTablaDocumentos">

                      <tr><td colspan="4" class="loading-message">Cargando datos...</td></tr>

                    </tbody>

                  </table>

                </div>

              </div>

            </div>

          </div>

        </div>

      </div>



      <div id="polizas" class="tab-content">

        <div class="content-body">

          <div class="card">

            <div class="card-header">Gesti√≥n de P√≥lizas</div>

            <div class="card-body">

              <h4 style="color:#2E86AB;">En desarrollo: Aqu√≠ ir√≠a la l√≥gica y visualizaci√≥n para las P√≥lizas.</h4>

            </div>

          </div>

        </div>

      </div>



    </div>

  </div>



<script>

  // Variables globales

  let cumplimientoChart;

  let datosDashboardGlobal = null; // Almacena el resultado completo de getControlData()

  

  // Funci√≥n para cambiar de pesta√±a

  function showTab(tabName, event) {

    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

    document.getElementById(tabName).classList.add('active');



    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));

    if (event && event.target) event.target.classList.add('active');



    const titulo = document.getElementById('titulo-seccion');

    if (tabName === 'documentos') {

      titulo.textContent = 'Control de Documentos M√©dicos';

      cargarDatosDocumentos();

    } else if (tabName === 'polizas') {

      titulo.textContent = 'Gesti√≥n de P√≥lizas';

    } else {

      titulo.textContent = 'Dashboard';

    }

  }



  /**

   * Carga los datos iniciales del script de Google Apps.

   */

  function cargarDatosDocumentos() {

    const cuerpo = document.getElementById('cuerpoTablaDocumentos');

    cuerpo.innerHTML = "<tr><td colspan='4' class='loading-message'>Cargando datos...</td></tr>";



    google.script.run

      .withSuccessHandler(data => {

        datosDashboardGlobal = data; 

        

        // 1. Llenar el filtro de especialidades (se basa en los datos globales)

        llenarFiltroEspecialidades(data.especialidades);

        

        // 2. Renderizar el dashboard CON los datos completos (TODAS)

        renderDashboard(data);

      })

      .withFailureHandler(err => {

        cuerpo.innerHTML = `<tr><td colspan='4' style='text-align:center;color:red'>‚ö†Ô∏è Error al cargar: ${err.message}</td></tr>`;

        console.error("Error al obtener datos:", err);

      })

      .getControlData();

  }



  /**

   * Llena el dropdown del filtro.

   */

  function llenarFiltroEspecialidades(especialidades) {

    const filtro = document.getElementById('filtroEspecialidadDocumentos');

    filtro.innerHTML = '<option value="TODAS">-- Todas las Especialidades --</option>';



    const especialidadesUnicas = [...new Set(especialidades)];

    especialidadesUnicas.sort();

    

    especialidadesUnicas.forEach(esp => {

      if (esp && esp.trim() !== "") {

        filtro.innerHTML += `<option value="${esp}">${esp}</option>`;

      }

    });

  }



  /**

   * Procesa los datos globales seg√∫n el filtro seleccionado y llama a renderDashboard.

   * Esto filtra TODO: m√©tricas, gr√°fico y tabla.

   */

  function aplicarFiltroCompleto() {

    if (!datosDashboardGlobal) return;



    const especialidadSeleccionada = document.getElementById('filtroEspecialidadDocumentos').value;



    let datosFiltrados;

    

    if (especialidadSeleccionada === "TODAS") {

      datosFiltrados = datosDashboardGlobal;

    } else {

      // 1. Filtrar el detalle por la especialidad

      const detalleFiltrado = datosDashboardGlobal.detalleMedicos.filter(medico => 

        medico.especialidad === especialidadSeleccionada

      );

      

      // 2. Recalcular las m√©tricas y los promedios del gr√°fico

      const { especialidades, promedioCumplimiento, totalMedicos, promedioGeneral } = 

        recalcularMetricas(detalleFiltrado, especialidadSeleccionada);



      datosFiltrados = {

        especialidades,

        promedioCumplimiento,

        totalMedicos,

        promedioGeneral,

        detalleMedicos: detalleFiltrado

      };

    }



    renderDashboard(datosFiltrados);

  }



  /**

   * Funci√≥n auxiliar para recalcular m√©tricas basado en un subconjunto de datos.

   */

  function recalcularMetricas(detalleMedicos, especialidad) {

      if (detalleMedicos.length === 0) {

          return { especialidades: [especialidad], promedioCumplimiento: [0], totalMedicos: 0, promedioGeneral: '0' };

      }

      

      // En el caso filtrado, solo hay una especialidad, pero la funci√≥n se mantiene general

      let sumCumplimiento = 0;

      detalleMedicos.forEach(medico => {

          sumCumplimiento += parseFloat(medico.cumplimiento.replace('%', ''));

      });



      const promedioGeneral = (sumCumplimiento / detalleMedicos.length).toFixed(1);

      

      return {

          especialidades: [especialidad],

          promedioCumplimiento: [promedioGeneral],

          totalMedicos: detalleMedicos.length,

          promedioGeneral: promedioGeneral

      };

  }





  /**

   * Renderiza las m√©tricas, la tabla y el gr√°fico con el conjunto de datos proporcionado (filtrado o completo).

   */

  function renderDashboard(data) {

    // 1. M√©tricas

    document.getElementById('total-medicos').textContent = data.totalMedicos || '0';

    document.getElementById('promedio-general').textContent = (data.promedioGeneral || '0') + '%';



    // 2. Tabla de Detalle

    const cuerpo = document.getElementById('cuerpoTablaDocumentos');

    cuerpo.innerHTML = '';

    

    if (!data.detalleMedicos || data.detalleMedicos.length === 0) {

      cuerpo.innerHTML = "<tr><td colspan='4' class='loading-message'>No hay datos registrados con este filtro.</td></tr>";

    } else {

      data.detalleMedicos.forEach(medico => {

        cuerpo.innerHTML += `

          <tr>

            <td>${medico.especialidad || ''}</td>

            <td>${medico.nombre || ''}</td>

            <td>${medico.cedula || ''}</td>

            <td>${medico.cumplimiento || '0%'}</td>

          </tr>`;

      });

    }



    // 3. Gr√°fico de Barras

    const ctx = document.getElementById('cumplimientoChart').getContext('2d');

    

    if (cumplimientoChart) { cumplimientoChart.destroy(); }

    

    // Definir color de barras: Azul principal para barras individuales, gris claro para el total.

    const chartColors = data.especialidades.map(() => '#00A3D9');



    cumplimientoChart = new Chart(ctx, {

      type: 'bar',

      data: {

        labels: data.especialidades,

        datasets: [{

          label: 'Promedio de Cumplimiento (%)',

          data: data.promedioCumplimiento,

          backgroundColor: chartColors,

          borderColor: '#007BA3',

          borderWidth: 1

        }]

      },

      options: {

        responsive: true, maintainAspectRatio: false,

        scales: {

          y: { beginAtZero: true, max: 100, title: { display: true, text: 'Cumplimiento (%)' } },

          x: { ticks: { maxRotation: 45, minRotation: 45, } }

        },

        plugins: { legend: { display: false } }

      }

    });

    document.getElementById('cumplimientoChart').style.height = '350px'; 

  }



  // Carga inicial al cargar la p√°gina

  document.addEventListener('DOMContentLoaded', () => {

    document.getElementById('documentos').classList.add('active');

    document.querySelector('.nav-menu .nav-link').classList.add('active');

    document.getElementById('titulo-seccion').textContent = 'Control de Documentos M√©dicos';

    cargarDatosDocumentos();

  });

</script>



</body>

</html>

