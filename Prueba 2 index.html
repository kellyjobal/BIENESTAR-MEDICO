  <!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <title>Dashboard Documentos y P√≥lizas</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

  <style>
    /* --- (mantengo exactamente tu CSS original) --- */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Verdana,sans-serif;background:#FAFBFC;height:100vh;overflow:hidden;}
    .app-container{display:flex;height:100vh}
    .sidebar{width:250px;background:#00A3D9;color:#fff;flex-shrink:0;overflow-y:auto;box-shadow:2px 0 10px rgba(0,0,0,.1);}
    .sidebar-header-1{padding:20px;background:#FFFFFF}
    .sidebar-header{padding:20px;background:#BED600;}
    .sidebar-header h1{font-size:1.1rem;text-align:center;color:#00A3D9}
    .nav-menu{list-style:none;padding:20px 0}
    .nav-item{margin:5px 15px}
    .nav-link{display:flex;align-items:center;padding:12px 15px;color:rgba(255,255,255,1);text-decoration:none;border-radius:8px;cursor:pointer;}
    .nav-link.active{background:#007BA3;}
    .main-content{flex:1;overflow-y:auto;background:#FAFBFC}
    .content-header{background:#fff;padding:20px 30px;border-bottom:1px solid #e9ecef}
    .content-header h2{color:#2E86AB;}
    .content-body{padding:30px;}
    .card{background:#fff;border-radius:12px;padding:0;margin-bottom:20px;border:1px solid #E5F2F7;box-shadow:0 4px 6px rgba(0,0,0,.06);}
    .card-header{padding:16px 20px;background:#E5F2F7;border-bottom:1px solid #E5F2F7;color:#2E86AB;font-weight:600;}
    .card-body{padding:18px 20px}
    .metric-grid {display: grid;grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));gap: 20px;margin-bottom: 20px;text-align: center;}
    .metric-card {background: #E5F2F7;padding: 20px;border-radius: 10px;box-shadow: 0 2px 4px rgba(0,0,0,.05);border-left: 5px solid #00A3D9;}
    .metric-card h3 {font-size: 2.5rem;color: #00A3D9;margin-bottom: 5px;}
    .metric-card p {color: #2E86AB;font-weight: 600;text-transform: uppercase;font-size: 0.85rem;}
    .chart-grid {display: grid;grid-template-columns: 1fr 1fr;gap: 20px;}
    .contenedor-tabla{width:100%;overflow-x:auto;margin-top:12px;border-radius:8px;max-height: 550px;overflow-y: auto;}
    .tabla{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .tabla thead tr{background:#00A3D9;color:#fff;font-weight:700}
    .tabla th,.tabla td{padding:12px 15px;border-bottom:1px solid #E5F2F7}
    .tabla tbody tr:hover {background-color: #F8FCFD;}
    .tabla thead th {position: sticky;top: 0;background: #00A3D9;color: white;z-index: 2;}
    .tab-content{display:none;}
    .tab-content.active{display:block;}
    .loading-message {text-align: center;padding: 20px;color: #00A3D9;font-size: 1.1rem;}

    /* Estilos para acorde√≥n y checks */
    .btn-ver {background:transparent;border:none;color:#007BA3;cursor:pointer;font-weight:600}
    .detalle-row {display:none;background:#F8FCFD}
    .doc-list {display:flex;flex-wrap:wrap;gap:8px}
    .doc-item {padding:6px 8px;border-radius:6px;background:#fff;border:1px solid #E5F2F7;display:flex;align-items:center;gap:8px;font-size:0.9rem}
    .doc-item .ok {color:#1e7e34;font-weight:700}
    .doc-item .no {color:#c82333;font-weight:700}
    .small {font-size:0.9rem}
    .nowrap {white-space:nowrap}
  </style>
</head>
<body>
  <div class="app-container">
    <nav class="sidebar">
      <div class="sidebar-header-1">
        <!-- logo: archivo subido (la herramienta convertir√° la ruta a URL si aplica) -->
        <img src="/mnt/data/28672e7c-b9d3-4674-47e2-acb5-df6a0da17a6d.png"
             alt="Logo"
             style="width: 150px; display:block; margin: 0 auto 10px auto;">
      </div>

      <div class="sidebar-header">
        <h1>CONTROL DE CUMPLIMIENTO</h1>
      </div>

      <ul class="nav-menu">
        <li class="nav-item"><a class="nav-link active" onclick="showTab('documentos', event)">üìÑ Documentos</a></li>
        <li class="nav-item"><a class="nav-link" onclick="showTab('polizas', event)">üìã P√≥lizas</a></li>
      </ul>
    </nav>

    <div class="main-content">
      <div class="content-header"><h2 id="titulo-seccion">Control de Documentos M√©dicos</h2></div>

      <div id="documentos" class="tab-content active">
        <div class="content-body">

          <div style="margin-bottom:20px; max-width: 350px;">
            <label for="filtroEspecialidadDocumentos" style="font-weight: 600; color: #2E86AB; display: block; margin-bottom: 5px;">Filtrar por Especialidad:</label>
            <select id="filtroEspecialidadDocumentos" onchange="aplicarFiltroCompleto()"
                    style="width: 100%; padding: 10px; border: 2px solid #E5F2F7; border-radius: 8px;">
              <option value="TODAS">-- Cargando especialidades... --</option>
            </select>
          </div>

          <div class="metric-grid">
            <div class="metric-card">
              <h3 id="total-medicos">0</h3>
              <p>Total de M√©dicos</p>
            </div>
            <div class="metric-card">
              <h3 id="promedio-general">0%</h3>
              <p>Promedio General de Cumplimiento</p>
            </div>
          </div>

          <div class="chart-grid">
            <div class="card">
              <div class="card-header">Cumplimiento Promedio por Especialidad</div>
              <div class="card-body">
                <canvas id="cumplimientoChart"></canvas>
              </div>
            </div>

            <div class="card" style="grid-column: span 2;">
              <div class="card-header">Detalle de Cumplimiento por M√©dico</div>
              <div class="card-body">
                <div class="contenedor-tabla">
                  <table id="tabla-detalle" class="tabla">
                    <thead>
                      <tr>
                        <th>Especialidad</th>
                        <th>C√©dula</th>
                        <th>Nombre Completo</th>
                        <th>Fecha Vencimiento P√≥liza RC</th>
                        <th>Hoja de vida</th>
                        <th>Documento identidad</th>
                        <th>Tarjeta profesional</th>
                        <th>Diploma y acta pregrado</th>
                        <th>Diploma y acta especialista</th>
                        <th>Diploma y acta subespecialidad</th>
                        <th>Certificado Tribunal √âtica</th>
                        <th>Convalidaci√≥n</th>
                        <th>Inscripci√≥n Rethus</th>
                        <th>Certificado ARL/Salud</th>
                        <th>Rethus actualizado</th>
                        <th>Certificado Bancario</th>
                        <th>RUT</th>
                        <th>Foto</th>
                        <th>Curso Violencia Sexual</th>
                        <th>Curso Donaci√≥n √ìrganos</th>
                        <th>Curso Soporte Respiratorio</th>
                        <th>% Cumplimiento</th>
                      </tr>
                    </thead>
                    <tbody id="cuerpoTablaDocumentos">
                      <tr><td colspan="25" class="loading-message">Cargando datos...</td></tr>
                    </tbody>
                  </table>

                </div>
                <p class="small" style="margin-top:8px;color:#6b7785">Haz clic en <b>Ver</b> para desplegar los documentos (Hoja E‚ÜíV).</p>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div id="polizas" class="tab-content">
        <div class="content-body">
          <div class="card">
            <div class="card-header">Gesti√≥n de P√≥lizas</div>
            <div class="card-body">
              <h4 style="color:#2E86AB;">En desarrollo: Aqu√≠ ir√≠a la l√≥gica y visualizaci√≥n para las P√≥lizas.</h4>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
  // Variables globales
  let cumplimientoChart;
  let datosDashboardGlobal = null; // Almacena el resultado completo de getControlData()
  let documentHeaders = []; // encabezados de documentos (E..V)

  function showTab(tabName, event) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');

    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    if (event && event.target) event.target.classList.add('active');

    const titulo = document.getElementById('titulo-seccion');
    if (tabName === 'documentos') {
      titulo.textContent = 'Control de Documentos M√©dicos';
      cargarDatosDocumentos();
    } else if (tabName === 'polizas') {
      titulo.textContent = 'Gesti√≥n de P√≥lizas';
    } else {
      titulo.textContent = 'Dashboard';
    }
  }

  /**
   * Carga los datos iniciales del script de Google Apps.
   */
  function cargarDatosDocumentos() {
    const cuerpo = document.getElementById('cuerpoTablaDocumentos');
    cuerpo.innerHTML = "<tr><td colspan='6' class='loading-message'>Cargando datos...</td></tr>";

    google.script.run
      .withSuccessHandler(data => {
        datosDashboardGlobal = data;

        // Obtener documentHeaders autom√°ticamente desde data (fila 2)
        if (Array.isArray(data.documentHeaders) && data.documentHeaders.length > 0) {
          documentHeaders = data.documentHeaders;
        } else if (data.detalleMedicos && data.detalleMedicos.length > 0) {
          documentHeaders = Object.keys(data.detalleMedicos[0].documentos || {});
        } else {
          documentHeaders = [];
        }

        llenarFiltroEspecialidades(data.especialidades || []);
        renderDashboard(data);
      })
      .withFailureHandler(err => {
        cuerpo.innerHTML = `<tr><td colspan='6' style='text-align:center;color:red'>‚ö†Ô∏è Error al cargar: ${err.message}</td></tr>`;
        console.error("Error al obtener datos:", err);
      })
      .getControlData();
  }

  function llenarFiltroEspecialidades(especialidades) {
    const filtro = document.getElementById('filtroEspecialidadDocumentos');
    filtro.innerHTML = '<option value="TODAS">-- Todas las Especialidades --</option>';
    const especialidadesUnicas = [...new Set(especialidades)];
    especialidadesUnicas.sort();
    especialidadesUnicas.forEach(esp => {
      if (esp && esp.trim() !== "") {
        filtro.innerHTML += `<option value="${esp}">${esp}</option>`;
      }
    });
  }

  function aplicarFiltroCompleto() {
    if (!datosDashboardGlobal) return;
    const especialidadSeleccionada = document.getElementById('filtroEspecialidadDocumentos').value;
    let datosFiltrados;
    if (especialidadSeleccionada === "TODAS") {
      datosFiltrados = datosDashboardGlobal;
    } else {
      const detalleFiltrado = datosDashboardGlobal.detalleMedicos.filter(medico =>
        medico.especialidad === especialidadSeleccionada
      );
      const { especialidades, promedioCumplimiento, totalMedicos, promedioGeneral } =
        recalcularMetricas(detalleFiltrado, especialidadSeleccionada);
      datosFiltrados = {
        especialidades,
        promedioCumplimiento,
        totalMedicos,
        promedioGeneral,
        detalleMedicos: detalleFiltrado
      };
    }
    renderDashboard(datosFiltrados);
  }

  function recalcularMetricas(detalleMedicos, especialidad) {
    if (!detalleMedicos || detalleMedicos.length === 0) {
      return { especialidades: [especialidad], promedioCumplimiento: [0], totalMedicos: 0, promedioGeneral: '0' };
    }
    let sumCumplimiento = 0;
    detalleMedicos.forEach(medico => {
      sumCumplimiento += parseFloat((medico.cumplimiento || '0').toString().replace('%', '')) || 0;
    });
    const promedioGeneral = (sumCumplimiento / detalleMedicos.length).toFixed(1);
    return {
      especialidades: [especialidad],
      promedioCumplimiento: [promedioGeneral],
      totalMedicos: detalleMedicos.length,
      promedioGeneral: promedioGeneral
    };
  }

  /**
   * Renderiza la tabla principal y prepara las filas expandibles (acorde√≥n)
   */
  function renderDashboard(data) {
    // M√©tricas
    document.getElementById('total-medicos').textContent = data.totalMedicos || '0';
    document.getElementById('promedio-general').textContent = (data.promedioGeneral || '0') + '%';

    const cuerpo = document.getElementById('cuerpoTablaDocumentos');
    cuerpo.innerHTML = '';

    if (!data.detalleMedicos || data.detalleMedicos.length === 0) {
      cuerpo.innerHTML = "<tr><td colspan='6' class='loading-message'>No hay datos registrados con este filtro.</td></tr>";
    } else {
      data.detalleMedicos.forEach((medico, idx) => {
        // fila principal
        const trMain = document.createElement('tr');

        const tdEsp = document.createElement('td'); tdEsp.textContent = medico.especialidad || ''; trMain.appendChild(tdEsp);
        const tdNom = document.createElement('td'); tdNom.textContent = medico.nombre || ''; trMain.appendChild(tdNom);
        const tdCed = document.createElement('td'); tdCed.textContent = medico.cedula || ''; trMain.appendChild(tdCed);
        const tdPol = document.createElement('td'); tdPol.textContent = medico.fechaPoliza || ''; trMain.appendChild(tdPol);
        const tdCum = document.createElement('td'); tdCum.textContent = medico.cumplimiento || '0%'; trMain.appendChild(tdCum);

        const tdVer = document.createElement('td');
        const btn = document.createElement('button');
        btn.className = 'btn-ver';
        btn.textContent = 'Ver';
        btn.onclick = () => toggleDetalle(idx);
        tdVer.appendChild(btn);
        trMain.appendChild(tdVer);

        cuerpo.appendChild(trMain);

        // fila detalle (inicialmente oculta)
        const trDetalle = document.createElement('tr');
        trDetalle.className = 'detalle-row';
        trDetalle.id = 'detalle-' + idx;

        const tdDetalle = document.createElement('td');
        tdDetalle.colSpan = 6;

        // construir lista de documentos visual
        const lista = document.createElement('div');
        lista.className = 'doc-list';

        if (medico.documentos && Object.keys(medico.documentos).length > 0) {
          for (const [docName, ok] of Object.entries(medico.documentos)) {
            const item = document.createElement('div');
            item.className = 'doc-item';
            const spanName = document.createElement('span');
            spanName.textContent = docName;
            const spanState = document.createElement('span');
            spanState.style.marginLeft = '8px';
            spanState.innerHTML = ok ? '<span class=\"ok\">‚úî</span>' : '<span class=\"no\">‚úò</span>';
            item.appendChild(spanName);
            item.appendChild(spanState);
            lista.appendChild(item);
          }
        } else {
          const p = document.createElement('div');
          p.textContent = 'No hay documentos listados.';
          lista.appendChild(p);
        }

        tdDetalle.appendChild(lista);
        trDetalle.appendChild(tdDetalle);
        cuerpo.appendChild(trDetalle);
      });
    }

    // Gr√°fico (igual que antes)
    const ctx = document.getElementById('cumplimientoChart').getContext('2d');
    if (cumplimientoChart) { cumplimientoChart.destroy(); }
    const chartColors = (data.especialidades || []).map(() => '#00A3D9');

    cumplimientoChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.especialidades || [],
        datasets: [{
          label: 'Promedio de Cumplimiento (%)',
          data: data.promedioCumplimiento || [],
          backgroundColor: chartColors,
          borderColor: '#007BA3',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, max: 100, title: { display: true, text: 'Cumplimiento (%)' } },
          x: { ticks: { maxRotation: 45, minRotation: 45, } }
        },
        plugins: { legend: { display: false } }
      }
    });
    document.getElementById('cumplimientoChart').style.height = '350px';
  }

  function toggleDetalle(idx) {
    const el = document.getElementById('detalle-' + idx);
    if (!el) return;
    el.style.display = (el.style.display === 'table-row') ? 'none' : 'table-row';
  }

  // Carga inicial
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('documentos').classList.add('active');
    document.querySelector('.nav-menu .nav-link').classList.add('active');
    document.getElementById('titulo-seccion').textContent = 'Control de Documentos M√©dicos';
    cargarDatosDocumentos();
  });
</script>

</body>
</html>
